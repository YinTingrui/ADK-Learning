<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºæ—…è¡Œè®¡åˆ’ - æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹</title>
    <!-- é«˜å¾·åœ°å›¾API - æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ -->
    <script type="text/javascript">
        // åœ°å›¾APIåŠ è½½ç®¡ç†å™¨ - å•ä¾‹æ¨¡å¼
        const MapAPIManager = {
            scriptLoaded: false,
            scriptLoading: false,
            loadCallbacks: [],
            
            loadScript(callback) {
                if (this.scriptLoaded) {
                    callback();
                    return;
                }
                
                this.loadCallbacks.push(callback);
                
                if (this.scriptLoading) {
                    return; // æ­£åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…å›è°ƒ
                }
                
                this.scriptLoading = true;
                
                // ä½¿ç”¨Intersection Observerè¿›ä¸€æ­¥ä¼˜åŒ–åŠ è½½æ—¶æœº
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        if (entries[0].isIntersecting && !this.scriptLoaded) {
                            this._loadMapScript();
                            observer.disconnect();
                        }
                    });
                    
                    // è§‚å¯Ÿåœ°å›¾å®¹å™¨
                    const mapContainer = document.getElementById('attractions-map');
                    if (mapContainer) {
                        observer.observe(mapContainer);
                    } else {
                        // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œç›´æ¥åŠ è½½
                        this._loadMapScript();
                    }
                } else {
                    // é™çº§æ–¹æ¡ˆ
                    this._loadMapScript();
                }
            },
            
            _loadMapScript() {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://webapi.amap.com/maps?v=2.0&key={{ amap_api_key }}';
                script.async = true;
                script.onload = () => {
                    this.scriptLoaded = true;
                    this.scriptLoading = false;
                    this._executeCallbacks();
                };
                script.onerror = () => {
                    this.scriptLoading = false;
                    console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥');
                    this._executeCallbacks(new Error('åœ°å›¾åŠ è½½å¤±è´¥'));
                };
                document.head.appendChild(script);
            },
            
            _executeCallbacks(error = null) {
                this.loadCallbacks.forEach(callback => callback(error));
                this.loadCallbacks = [];
            }
        };
        
        // å‘åå…¼å®¹
        function loadMapScript(callback) {
            MapAPIManager.loadScript(callback);
        }
    </script>
    
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            margin-top: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #34495e;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .plan-result {
            margin-top: 20px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .weather-day {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .weather-day:last-child {
            border-bottom: none;
        }
        .attraction-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .attraction-item:last-child {
            border-bottom: none;
        }
        .route-day {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .route-day:last-child {
            border-bottom: none;
        }
        .route-spot {
            margin-left: 20px;
            margin-top: 10px;
        }
        .route-spot div {
            margin-bottom: 5px;
        }
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        button[type="submit"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #667eea;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ</a>
        <h1><i class="fas fa-route"></i> æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹</h1>
        <h2><i class="fas fa-calendar-plus"></i> åˆ›å»ºæ—…è¡Œè®¡åˆ’</h2>
        
        <div class="form-container">
            <form id="plan-form">
                <div class="form-group">
                    <label for="city">ç›®çš„åœ°åŸå¸‚</label>
                    <input type="text" id="city" name="city" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ­å·" required>
                </div>
                
                <div class="form-group">
                    <label for="start-date">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="start-date" name="start-date" required>
                </div>
                
                <div class="form-group">
                    <label for="days">æ—…è¡Œå¤©æ•°</label>
                    <select id="days" name="days">
                        <option value="1">1å¤©</option>
                        <option value="2">2å¤©</option>
                        <option value="3" selected>3å¤©</option>
                        <option value="4">4å¤©</option>
                        <option value="5">5å¤©</option>
                        <option value="6">6å¤©</option>
                        <option value="7">7å¤©</option>
                    </select>
                </div>
                
                <button type="submit">ç”Ÿæˆæ—…è¡Œè®¡åˆ’</button>
            </form>

            <div id="plan-result" class="plan-result" style="display: none;">
                <h3 id="plan-title"></h3>
                
                <!-- å¤©æ°”ä¿¡æ¯ -->
                <div class="section">
                    <div class="section-title">ğŸ“… å¤©æ°”é¢„æŠ¥</div>
                    <div id="weather-forecast"></div>
                </div>
                
                <!-- æ™¯ç‚¹æ¨è -->
                <div class="section">
                    <div class="section-title">ğŸï¸ çƒ­é—¨æ™¯ç‚¹</div>
                    <div id="attractions-list"></div>
                </div>
                
                <!-- è¡Œç¨‹å®‰æ’ -->
                <div class="section">
                    <div class="section-title">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹</div>
                    <div id="daily-routes"></div>
                </div>
                
                <!-- æ—…è¡Œå»ºè®® -->
                <div class="section">
                    <div class="section-title">ğŸ’¡ æ—…è¡Œå»ºè®®</div>
                    <div id="travel-suggestions"></div>
                </div>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <div style="text-align: center; padding: 20px;">
                    <h3>æ­£åœ¨ç”Ÿæˆæ‚¨çš„æ—…è¡Œè®¡åˆ’...</h3>
                    <div style="margin: 20px 0;">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentPlan = null;
        let currentAttractions = [];
        
        // æ¨¡å—åŒ–ä»£ç ç»“æ„
        const TravelPlanModule = (function() {
            'use strict';
            
            // ç§æœ‰å˜é‡
            let moduleInstance = null;
            
            // ç¼“å­˜ç®¡ç†å™¨ç±»
            class CacheManager {
                constructor(maxSize = 50, defaultTTL = 5 * 60 * 1000) {
                    this.data = new Map();
                    this.maxSize = maxSize;
                    this.defaultTTL = defaultTTL;
                    this.stats = {
                        hits: 0,
                        misses: 0,
                        evictions: 0
                    };
                }
                
                set(key, value, ttl = this.defaultTTL) {
                    if (this.data.size >= this.maxSize) {
                        const firstKey = this.data.keys().next().value;
                        this.data.delete(firstKey);
                        this.stats.evictions++;
                    }
                    this.data.set(key, {
                        value: value,
                        expiry: Date.now() + ttl
                    });
                }
                
                get(key) {
                    const item = this.data.get(key);
                    if (!item) {
                        this.stats.misses++;
                        return null;
                    }
                    
                    if (Date.now() > item.expiry) {
                        this.data.delete(key);
                        this.stats.misses++;
                        return null;
                    }
                    
                    this.stats.hits++;
                    return item.value;
                }
                
                clear() {
                    this.data.clear();
                    this.stats = { hits: 0, misses: 0, evictions: 0 };
                }
                
                getStats() {
                    return {
                        ...this.stats,
                        size: this.data.size,
                        hitRate: this.stats.hits / (this.stats.hits + this.stats.misses) || 0
                    };
                }
            }
            
            // å·¥å…·å‡½æ•°ç±»
            class Utils {
                static debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }
                
                static throttle(func, limit) {
                    let inThrottle;
                    return function() {
                        const args = arguments;
                        const context = this;
                        if (!inThrottle) {
                            func.apply(context, args);
                            inThrottle = true;
                            setTimeout(() => inThrottle = false, limit);
                        }
                    };
                }
                
                static formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
                
                static showLoading(element, text = 'åŠ è½½ä¸­...') {
                    if (element) {
                        element.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> ${text}</div>`;
                    }
                }
                
                static hideLoading(element) {
                    if (element) {
                        const loading = element.querySelector('.loading');
                        if (loading) loading.remove();
                    }
                }
            }
            
            // é€šçŸ¥æ¨¡å—ç±»
            class NotificationModule {
                constructor() {
                    this.container = null;
                    this.init();
                }
                
                init() {
                    this.container = document.createElement('div');
                    this.container.className = 'notification-container';
                    document.body.appendChild(this.container);
                }
                
                show(message, type = 'info', duration = 3000) {
                    const notification = document.createElement('div');
                    notification.className = `notification notification-${type}`;
                    notification.innerHTML = `
                        <div class="notification-content">
                            <i class="fas fa-${this.getIcon(type)}"></i>
                            <span>${message}</span>
                        </div>
                        <button class="notification-close">&times;</button>
                    `;
                    
                    this.container.appendChild(notification);
                    
                    // æ˜¾ç¤ºåŠ¨ç”»
                    setTimeout(() => notification.classList.add('show'), 10);
                    
                    // è‡ªåŠ¨å…³é—­
                    const timeout = setTimeout(() => {
                        this.hide(notification);
                    }, duration);
                    
                    // æ‰‹åŠ¨å…³é—­
                    notification.querySelector('.notification-close').addEventListener('click', () => {
                        clearTimeout(timeout);
                        this.hide(notification);
                    });
                }
                
                hide(notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
                
                getIcon(type) {
                    const icons = {
                        success: 'check-circle',
                        error: 'exclamation-circle',
                        warning: 'exclamation-triangle',
                        info: 'info-circle'
                    };
                    return icons[type] || 'info-circle';
                }
            }
            
            // ä¸»æ¨¡å—ç±»
            class TravelPlanModule {
                constructor() {
                    this.cache = new CacheManager();
                    this.utils = Utils;
                    this.notification = new NotificationModule();
                    this.isInitialized = false;
                }
                
                init() {
                    if (this.isInitialized) return;
                    
                    this.setupEventListeners();
                    this.setupErrorHandlers();
                    this.isInitialized = true;
                    
                    console.log('æ—…è¡Œè®¡åˆ’æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
                }
                
                setupEventListeners() {
                    // äº‹ä»¶ç›‘å¬å°†åœ¨ä¸‹é¢å®ç°
                }
                
                setupErrorHandlers() {
                    // é”™è¯¯å¤„ç†å°†åœ¨ä¸‹é¢å®ç°
                }
                
                // å…¶ä»–æ–¹æ³•å°†åœ¨ä¸‹é¢å®ç°...
            }
            
            // å•ä¾‹æ¨¡å¼
            return {
                getInstance: function() {
                    if (!moduleInstance) {
                        moduleInstance = new TravelPlanModule();
                    }
                    return moduleInstance;
                }
            };
        })();
        
        // åˆå§‹åŒ–æ¨¡å—
        const travelModule = TravelPlanModule.getInstance();
        
        // å…¼å®¹åŸæœ‰ä»£ç çš„å…¨å±€å˜é‡
        let travelPlanData = null;
        let currentCity = '';
        let currentDays = 0;
        let currentStartDate = '';
        
        // å‰ç«¯ç¼“å­˜æœºåˆ¶ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        const cacheManager = TravelPlanModule.getInstance().cache;
        
        // é˜²æŠ–å‡½æ•°ä¼˜åŒ–ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        function debounce(func, wait, immediate = false) {
            return TravelPlanModule.getInstance().utils.debounce(func, wait, immediate);
        }
        
        // èŠ‚æµå‡½æ•°ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        function throttle(func, limit) {
            return TravelPlanModule.getInstance().utils.throttle(func, limit);
        }
        
        // æ·»åŠ è¡¨å•æäº¤äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('plan-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
                    generateTravelPlan(); // è°ƒç”¨ç”Ÿæˆæ—…è¡Œè®¡åˆ’å‡½æ•°
                });
            }
        });
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯æ•è·:', event.error);
            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
            travelModule.notification.show('ç³»ç»Ÿå‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        });
        
        // ç½‘ç»œè¯·æ±‚é”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            travelModule.notification.show('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        });
        
        // æ˜¾ç¤ºæ—…è¡Œè®¡åˆ’å‡½æ•° - é‡æ„ç‰ˆæœ¬
        function displayTravelPlan(plan) {
            const module = TravelPlanModule.getInstance();
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            const planResult = document.getElementById('plan-result');
            planResult.style.display = 'block';
            
            // è®¾ç½®è®¡åˆ’æ ‡é¢˜
            let planTitle = `${currentCity} ${currentDays}å¤©æ—…è¡Œè®¡åˆ’`;
            if (plan.enhanced_by_ai) {
                planTitle += ' <span style="color: #667eea;">(AIæ™ºèƒ½å¢å¼º)</span>';
            }
            document.getElementById('plan-title').innerHTML = planTitle;
            
            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–DOMæ“ä½œ
            const fragment = document.createDocumentFragment();
            
            // å¡«å……å¤©æ°”ä¿¡æ¯
            const weatherContainer = document.getElementById('weather-forecast');
            weatherContainer.innerHTML = '';
            if (plan.sections.weather_forecast) {
                const weatherFragment = document.createDocumentFragment();
                plan.sections.weather_forecast.forEach(day => {
                    const weatherDay = document.createElement('div');
                    weatherDay.className = 'weather-day';
                    const dayName = day.day || 'æœªçŸ¥';
                    const dateStr = day.date || '';
                    const weather = day.weather || 'æ™´';
                    const tempMin = day.temp_min || '20';
                    const tempMax = day.temp_max || '28';
                    const suggestion = day.suggestion || 'é€‚åˆå‡ºæ¸¸ï¼Œè®°å¾—åšå¥½é˜²æ™’';
                    
                    weatherDay.innerHTML = `
                        <strong>${dayName} (${dateStr})</strong><br>
                        å¤©æ°”: ${weather}<br>
                        æ¸©åº¦: ${tempMin} ~ ${tempMax}Â°C<br>
                        å»ºè®®: ${suggestion}
                    `;
                    weatherFragment.appendChild(weatherDay);
                });
                weatherContainer.appendChild(weatherFragment);
            }
            
            // å¡«å……æ™¯ç‚¹ä¿¡æ¯å’Œåœ°å›¾
            const attractionsContainer = document.getElementById('attractions-list');
            attractionsContainer.innerHTML = '';
            if (plan.sections.attractions) {
                // åˆ›å»ºåœ°å›¾å®¹å™¨
                const mapContainer = document.createElement('div');
                mapContainer.id = 'attractions-map';
                mapContainer.style.cssText = 'width: 100%; height: 400px; margin: 20px 0; border: 1px solid #ddd; border-radius: 8px;';
                attractionsContainer.appendChild(mapContainer);
                
                // åˆ›å»ºæ™¯ç‚¹åˆ—è¡¨å®¹å™¨
                const listContainer = document.createElement('div');
                listContainer.id = 'attractions-list-items';
                attractionsContainer.appendChild(listContainer);
                
                // ä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯å¤„ç†å¤§é‡æ™¯ç‚¹
                if (plan.sections.attractions.length > 50) {
                    renderVirtualizedAttractions(listContainer, plan.sections.attractions);
                } else {
                    // å¡«å……æ™¯ç‚¹åˆ—è¡¨
                    const attractionsFragment = document.createDocumentFragment();
                    const attractions = plan.sections.attractions;
                    attractions.forEach((attraction, index) => {
                        const attractionItem = document.createElement('div');
                        attractionItem.className = 'attraction-item';
                        attractionItem.innerHTML = `
                            <strong>${attraction.name}</strong><br>
                            è¯„åˆ†: ${attraction.rating}<br>
                            æè¿°: ${attraction.description}
                        `;
                        attractionsFragment.appendChild(attractionItem);
                    });
                    listContainer.appendChild(attractionsFragment);
                }
                
                // åˆå§‹åŒ–åœ°å›¾ï¼ˆå»¶è¿Ÿæ‰§è¡Œç¡®ä¿å®¹å™¨å·²æ¸²æŸ“ï¼‰
                setTimeout(() => {
                    initAttractionsMap(plan.sections.attractions, currentCity);
                }, 100);
            }
            
            // å¡«å……è¡Œç¨‹å®‰æ’
            const routesContainer = document.getElementById('daily-routes');
            routesContainer.innerHTML = '';
            if (plan.sections.routes) {
                const routesFragment = document.createDocumentFragment();
                plan.sections.routes.forEach(route => {
                    const routeDay = document.createElement('div');
                    routeDay.className = 'route-day';
                    routeDay.innerHTML = `<strong>${route.title}</strong>`;
                    
                    const spotsList = document.createElement('div');
                    spotsList.className = 'route-spot';
                    
                    route.attractions.forEach(spot => {
                        const spotItem = document.createElement('div');
                        spotItem.innerHTML = `<strong>${spot.time}</strong> - ${spot.name}`;
                        spotsList.appendChild(spotItem);
                    });
                    
                    routeDay.appendChild(spotsList);
                    routesFragment.appendChild(routeDay);
                });
                routesContainer.appendChild(routesFragment);
            }
            
            // å¡«å……æ—…è¡Œå»ºè®®
            const suggestionsContainer = document.getElementById('travel-suggestions');
            suggestionsContainer.innerHTML = '';
            if (plan.sections.suggestions) {
                const suggestionsFragment = document.createDocumentFragment();
                plan.sections.suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.innerHTML = `<strong>${suggestion.type}</strong>: ${suggestion.content}`;
                    suggestionsFragment.appendChild(suggestionItem);
                });
                suggestionsContainer.appendChild(suggestionsFragment);
            }
            
            // æ˜¾ç¤ºæ€§èƒ½ç»Ÿè®¡
            console.log('æ—…è¡Œè®¡åˆ’æ˜¾ç¤ºå®Œæˆï¼Œç¼“å­˜å‘½ä¸­ç‡:', module.cache.getStats().hitRate);
        }
        
        // è™šæ‹ŸåŒ–æ¸²æŸ“å¤§é‡æ™¯ç‚¹
        function renderVirtualizedAttractions(container, attractions) {
            const itemHeight = 80; // æ¯ä¸ªæ™¯ç‚¹é¡¹çš„é«˜åº¦
            const containerHeight = 400; // å®¹å™¨é«˜åº¦
            const visibleItems = Math.ceil(containerHeight / itemHeight);
            
            // åˆ›å»ºæ»šåŠ¨å®¹å™¨
            const scrollContainer = document.createElement('div');
            scrollContainer.style.cssText = `height: ${containerHeight}px; overflow-y: auto; position: relative;`;
            
            // åˆ›å»ºå†…å®¹å ä½ç¬¦
            const contentSpacer = document.createElement('div');
            contentSpacer.style.cssText = `height: ${attractions.length * itemHeight}px;`;
            
            // åˆ›å»ºå¯è§å†…å®¹å®¹å™¨
            const visibleContainer = document.createElement('div');
            visibleContainer.style.cssText = 'position: absolute; top: 0; left: 0; right: 0;';
            
            scrollContainer.appendChild(contentSpacer);
            scrollContainer.appendChild(visibleContainer);
            container.appendChild(scrollContainer);
            
            // æ¸²æŸ“å‡½æ•°
            function renderVisibleItems() {
                const scrollTop = scrollContainer.scrollTop;
                const startIndex = Math.floor(scrollTop / itemHeight);
                const endIndex = Math.min(startIndex + visibleItems + 2, attractions.length); // +2 ä½œä¸ºç¼“å†²åŒº
                
                const fragment = document.createDocumentFragment();
                for (let i = startIndex; i < endIndex; i++) {
                    const attraction = attractions[i];
                    const item = document.createElement('div');
                    item.className = 'attraction-item';
                    item.style.cssText = `position: absolute; top: ${i * itemHeight}px; height: ${itemHeight}px;`;
                    item.innerHTML = `
                        <strong>${attraction.name}</strong><br>
                        è¯„åˆ†: ${attraction.rating}<br>
                        æè¿°: ${attraction.description}
                    `;
                    fragment.appendChild(item);
                }
                
                visibleContainer.innerHTML = '';
                visibleContainer.appendChild(fragment);
            }
            
            // åˆå§‹æ¸²æŸ“
            renderVisibleItems();
            
            // æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼ˆä½¿ç”¨èŠ‚æµä¼˜åŒ–ï¼‰
            const module = TravelPlanModule.getInstance();
            const throttledRender = module.utils.throttle(renderVisibleItems, 16); // 60fps
            scrollContainer.addEventListener('scroll', throttledRender);
        }
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .notification-close {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                margin-left: 10px;
                padding: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .notification-close:hover {
                opacity: 0.8;
            }
        `;
        document.head.appendChild(style);
        
        // è¡¨å•æäº¤å¤„ç†å‡½æ•° - é‡æ„ç‰ˆæœ¬
        async function generateTravelPlan() {
            const module = TravelPlanModule.getInstance();
            const cityInput = document.getElementById('city');
            const daysInput = document.getElementById('days');
            const startDateInput = document.getElementById('start-date');
            
            // éªŒè¯è¾“å…¥
            if (!cityInput.value.trim()) {
                module.notification.show('è¯·è¾“å…¥ç›®çš„åœ°åŸå¸‚', 'warning');
                cityInput.focus();
                return;
            }
            
            if (!daysInput.value || daysInput.value < 1) {
                module.notification.show('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—…è¡Œå¤©æ•°', 'warning');
                daysInput.focus();
                return;
            }
            
            if (!startDateInput.value) {
                module.notification.show('è¯·é€‰æ‹©å‡ºå‘æ—¥æœŸ', 'warning');
                startDateInput.focus();
                return;
            }
            
            const city = cityInput.value.trim();
            const days = parseInt(daysInput.value);
            const startDate = startDateInput.value;
            
            // åˆ›å»ºç¼“å­˜é”®
            const cacheKey = `travel_plan_${city}_${days}_${startDate}`;
            
            // æ£€æŸ¥ç¼“å­˜
            const cachedData = module.cache.get(cacheKey);
            if (cachedData) {
                console.log('ä½¿ç”¨ç¼“å­˜çš„æ—…è¡Œè®¡åˆ’æ•°æ®');
                displayTravelPlan(cachedData);
                module.notification.show('å·²åŠ è½½ç¼“å­˜çš„æ—…è¡Œè®¡åˆ’', 'info', 2000);
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const planResult = document.getElementById('plan-result');
            module.utils.showLoading(planResult, 'æ­£åœ¨ç”Ÿæˆæ—…è¡Œè®¡åˆ’...');
            
            try {
                // æ·»åŠ è¯·æ±‚è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
                
                const response = await fetch('/api/travel-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        city: city,
                        days: days,
                        start_date: startDate
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.success && result.plan) {
                        // ç¼“å­˜ç»“æœ
                        module.cache.set(cacheKey, result.plan);
                        
                        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                        module.notification.show('æ—…è¡Œè®¡åˆ’ç”ŸæˆæˆåŠŸï¼', 'success');
                        
                        // æ˜¾ç¤ºç»“æœ
                        displayTravelPlan(result.plan);
                        
                        // æ›´æ–°å…¨å±€å˜é‡
                        travelPlanData = result.plan;
                        currentCity = city;
                        currentDays = days;
                        currentStartDate = startDate;
                        
                        // è®°å½•ç¼“å­˜ç»Ÿè®¡
                        console.log('ç¼“å­˜ç»Ÿè®¡:', module.cache.getStats());
                        
                    } else {
                        throw new Error(result.error || 'ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥');
                    }
                } else {
                    throw new Error(result.error || 'æœåŠ¡å™¨é”™è¯¯');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥:', error);
                
                let errorMessage = 'ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥';
                if (error.name === 'AbortError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                module.notification.show(errorMessage, 'error');
                
                planResult.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>ç”Ÿæˆå¤±è´¥</h3>
                        <p>${errorMessage}</p>
                        <button onclick="generateTravelPlan()" class="retry-btn">é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        // è·å–æ™¯ç‚¹åæ ‡å¹¶åˆå§‹åŒ–åœ°å›¾ - ä¼˜åŒ–ç‰ˆæœ¬
        // ä¼˜åŒ–åœ°å›¾åˆå§‹åŒ–å‡½æ•°
        function initAttractionsMap(attractions, cityName) {
            if (!attractions || attractions.length === 0) {
                console.log('æ²¡æœ‰æ™¯ç‚¹æ•°æ®');
                document.getElementById('attractions-map').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">æš‚æ— æ™¯ç‚¹ä¿¡æ¯</div>';
                return;
            }
            
            // ä½¿ç”¨é˜²æŠ–æœºåˆ¶é¿å…é‡å¤è®¡ç®—
            if (window.mapInitTimeout) {
                clearTimeout(window.mapInitTimeout);
            }
            
            window.mapInitTimeout = setTimeout(() => {
                try {
                    // è¿‡æ»¤æœ‰æ•ˆåæ ‡æ•°æ®
                    const validAttractions = attractions.filter(attr => 
                        attr.longitude && attr.latitude && 
                        !isNaN(attr.longitude) && !isNaN(attr.latitude) &&
                        Math.abs(attr.longitude) <= 180 && Math.abs(attr.latitude) <= 90
                    );
                    
                    if (validAttractions.length === 0) {
                        console.log('æ²¡æœ‰æœ‰æ•ˆçš„æ™¯ç‚¹åæ ‡');
                        document.getElementById('attractions-map').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">æš‚æ— æ™¯ç‚¹ä½ç½®ä¿¡æ¯</div>';
                        return;
                    }
                    
                    // ä½¿ç”¨æ›´å¿«çš„ç®—æ³•è®¡ç®—ä¸­å¿ƒç‚¹
                    const bounds = validAttractions.reduce((acc, attr) => {
                        const lng = parseFloat(attr.longitude);
                        const lat = parseFloat(attr.latitude);
                        return {
                            minLng: Math.min(acc.minLng, lng),
                            maxLng: Math.max(acc.maxLng, lng),
                            minLat: Math.min(acc.minLat, lat),
                            maxLat: Math.max(acc.maxLat, lat)
                        };
                    }, { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                    
                    const centerLng = (bounds.minLng + bounds.maxLng) / 2;
                    const centerLat = (bounds.minLat + bounds.maxLat) / 2;
                    
                    console.log(`è®¡ç®—å‡ºçš„ä¸­å¿ƒåæ ‡: ${centerLng}, ${centerLat}`);
                    
                    // æ ¹æ®æ•°æ®é‡é€‰æ‹©å¤„ç†ç­–ç•¥
                    if (validAttractions.length > 50) {
                        // å¤§é‡æ•°æ®ä½¿ç”¨åˆ†æ‰¹å¤„ç†
                        processLargeAttractionsData(validAttractions, centerLng, centerLat);
                    } else {
                        // å»¶è¿ŸåŠ è½½åœ°å›¾APIå¹¶åˆ›å»ºåœ°å›¾
                        loadMapScript((error) => {
                            if (error) {
                                document.getElementById('attractions-map').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                                return;
                            }
                            createMap(centerLng, centerLat, validAttractions);
                        });
                    }
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–åœ°å›¾å¤±è´¥:', error);
                    document.getElementById('attractions-map').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">åœ°å›¾åˆå§‹åŒ–å¤±è´¥</div>';
                }
            }, 150); // å¢åŠ é˜²æŠ–å»¶è¿Ÿåˆ°150ms
        }
        
        // å¤„ç†å¤§é‡æ™¯ç‚¹æ•°æ®
        function processLargeAttractionsData(attractions, centerLng, centerLat) {
            console.log(`å¤„ç†å¤§é‡æ™¯ç‚¹æ•°æ®: ${attractions.length} ä¸ªæ™¯ç‚¹`);
            
            // åˆ†æ‰¹å¤„ç†æ•°æ®
            const batchSize = 50;
            let currentBatch = 0;
            
            function processBatch() {
                const start = currentBatch * batchSize;
                const end = Math.min(start + batchSize, attractions.length);
                
                if (start < attractions.length) {
                    const batchData = attractions.slice(start, end);
                    
                    // å¤„ç†å½“å‰æ‰¹æ¬¡
                    setTimeout(() => {
                        console.log(`å¤„ç†æ‰¹æ¬¡ ${currentBatch + 1}: ${start + 1}-${end}`);
                        
                        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ‰¹æ¬¡ï¼Œåˆ›å»ºåœ°å›¾
                        if (currentBatch === 0) {
                            loadMapScript((error) => {
                                if (error) {
                                    document.getElementById('attractions-map').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                                    return;
                                }
                                createMap(centerLng, centerLat, attractions);
                            });
                        }
                        
                        currentBatch++;
                        processBatch(); // å¤„ç†ä¸‹ä¸€ä¸ªæ‰¹æ¬¡
                    }, 50); // æ¯æ‰¹æ¬¡é—´éš”50ms
                }
            }
            
            processBatch();
        }
        
        // åˆ›å»ºåœ°å›¾å‡½æ•° - ä¼˜åŒ–ç‰ˆæœ¬
        function createMap(centerLng, centerLat, attractions) {
            try {
                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
                requestAnimationFrame(() => {
                    const map = new AMap.Map('attractions-map', {
                        center: [centerLng, centerLat],
                        zoom: 12,
                        resizeEnable: true,
                        // ä¼˜åŒ–åœ°å›¾æ€§èƒ½
                        animateEnable: false, // ç¦ç”¨åŠ¨ç”»æé«˜æ€§èƒ½
                        jogEnable: false,
                        pitchEnable: false,
                        rotateEnable: false
                    });
                    
                    // æ·»åŠ æ§ä»¶
                    map.addControl(new AMap.Scale());
                    map.addControl(new AMap.ToolBar({liteStyle: true}));
                    
                    // æ·»åŠ åœ°å›¾ç±»å‹åˆ‡æ¢æ§ä»¶
                    addMapTypeControl(map);
                    
                    // æ·»åŠ å…¨å±æ§ä»¶
                    addFullscreenControl(map);
                    
                    // æ‰¹é‡æ·»åŠ æ™¯ç‚¹æ ‡è®°ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
                    const attractionsWithCoords = attractions.filter(attr => attr.longitude && attr.latitude);
                    
                    if (attractionsWithCoords.length === 0) {
                        document.getElementById('attractions-map').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">æš‚æ— æ™¯ç‚¹ä½ç½®ä¿¡æ¯</div>';
                        return;
                    }
                    
                    // ä½¿ç”¨MarkerClustererè¿›è¡Œèšåˆæ˜¾ç¤ºï¼ˆå¦‚æœæ™¯ç‚¹å¾ˆå¤šï¼‰
                    if (attractionsWithCoords.length > 20) {
                        createClusteredMarkers(map, attractionsWithCoords);
                    } else {
                        createIndividualMarkers(map, attractionsWithCoords);
                    }
                    
                    // æ·»åŠ åœ°å›¾æ€§èƒ½ç›‘æ§
                    optimizeMapPerformance(map);
                    
                    // æ·»åŠ åœ°å›¾æœç´¢åŠŸèƒ½
                    addMapSearchControl(map);
                    
                    // æ·»åŠ åœ°å›¾ç»Ÿè®¡ä¿¡æ¯
                    addMapStats(map, attractionsWithCoords);
                    
                    // è‡ªé€‚åº”åœ°å›¾è§†é‡
                    if (attractionsWithCoords.length > 1) {
                        const bounds = new AMap.Bounds();
                        attractionsWithCoords.forEach(attraction => {
                            bounds.extend([parseFloat(attraction.longitude), parseFloat(attraction.latitude)]);
                        });
                        map.setBounds(bounds);
                    }
                    
                    // ä¿å­˜åœ°å›¾å¼•ç”¨ä¾›åç»­ä½¿ç”¨
                    window.currentMap = map;
                });
                
            } catch (error) {
                console.error('åˆ›å»ºåœ°å›¾å¤±è´¥:', error);
                document.getElementById('attractions-map').innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">åœ°å›¾åˆ›å»ºå¤±è´¥</div>';
            }
        }
        
        // æ·»åŠ åœ°å›¾ç±»å‹åˆ‡æ¢æ§ä»¶ - ä¼˜åŒ–ç‰ˆæœ¬
        function addMapTypeControl(map) {
            try {
                // åˆ›å»ºè‡ªå®šä¹‰åœ°å›¾ç±»å‹åˆ‡æ¢æ§ä»¶
                const mapTypeControl = new AMap.Control({
                    position: 'RT',
                    offset: new AMap.Pixel(10, 10)
                });
                
                // æ§ä»¶å†…å®¹ - ç°ä»£åŒ–è®¾è®¡
                const controlContent = document.createElement('div');
                controlContent.className = 'map-type-control';
                controlContent.innerHTML = `
                    <div style="background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); backdrop-filter: blur(10px);">
                        <div style="display: flex; gap: 4px;">
                            <button id="roadmap-btn" class="map-type-btn active" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #007bff; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease;">
                                <i class="fas fa-road"></i>
                                è¡—é“å›¾
                            </button>
                            <button id="satellite-btn" class="map-type-btn" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e0e0e0; background: white; color: #333; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease;">
                                <i class="fas fa-satellite"></i>
                                å«æ˜Ÿå›¾
                            </button>
                        </div>
                    </div>
                `;
                
                mapTypeControl.content = controlContent;
                map.addControl(mapTypeControl);
                
                // ç»‘å®šæŒ‰é’®äº‹ä»¶ - æ·»åŠ æ‚¬åœæ•ˆæœ
                setTimeout(() => {
                    const roadmapBtn = document.getElementById('roadmap-btn');
                    const satelliteBtn = document.getElementById('satellite-btn');
                    
                    if (roadmapBtn) {
                        // æ·»åŠ æ‚¬åœæ•ˆæœ
                        roadmapBtn.addEventListener('mouseenter', () => {
                            if (!roadmapBtn.classList.contains('active')) {
                                roadmapBtn.style.background = '#f0f8ff';
                                roadmapBtn.style.borderColor = '#007bff';
                            }
                        });
                        
                        roadmapBtn.addEventListener('mouseleave', () => {
                            if (!roadmapBtn.classList.contains('active')) {
                                roadmapBtn.style.background = 'white';
                                roadmapBtn.style.borderColor = '#e0e0e0';
                            }
                        });
                        
                        roadmapBtn.addEventListener('click', () => {
                            map.setLayers([new AMap.TileLayer()]);
                            roadmapBtn.className = 'map-type-btn active';
                            roadmapBtn.style.background = '#007bff';
                            roadmapBtn.style.color = 'white';
                            roadmapBtn.style.borderColor = '#007bff';
                            satelliteBtn.className = 'map-type-btn';
                            satelliteBtn.style.background = 'white';
                            satelliteBtn.style.color = '#333';
                            satelliteBtn.style.borderColor = '#e0e0e0';
                            
                            // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
                            roadmapBtn.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                roadmapBtn.style.transform = 'scale(1)';
                            }, 100);
                        });
                    }
                    
                    if (satelliteBtn) {
                        // æ·»åŠ æ‚¬åœæ•ˆæœ
                        satelliteBtn.addEventListener('mouseenter', () => {
                            if (!satelliteBtn.classList.contains('active')) {
                                satelliteBtn.style.background = '#f0f8ff';
                                satelliteBtn.style.borderColor = '#007bff';
                            }
                        });
                        
                        satelliteBtn.addEventListener('mouseleave', () => {
                            if (!satelliteBtn.classList.contains('active')) {
                                satelliteBtn.style.background = 'white';
                                satelliteBtn.style.borderColor = '#e0e0e0';
                            }
                        });
                        
                        satelliteBtn.addEventListener('click', () => {
                            map.setLayers([new AMap.TileLayer.Satellite()]);
                            satelliteBtn.className = 'map-type-btn active';
                            satelliteBtn.style.background = '#007bff';
                            satelliteBtn.style.color = 'white';
                            satelliteBtn.style.borderColor = '#007bff';
                            roadmapBtn.className = 'map-type-btn';
                            roadmapBtn.style.background = 'white';
                            roadmapBtn.style.color = '#333';
                            roadmapBtn.style.borderColor = '#e0e0e0';
                            
                            // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
                            satelliteBtn.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                satelliteBtn.style.transform = 'scale(1)';
                            }, 100);
                        });
                    }
                }, 100);
                
            } catch (error) {
                console.error('æ·»åŠ åœ°å›¾ç±»å‹æ§ä»¶å¤±è´¥:', error);
                showNotification('åœ°å›¾ç±»å‹åˆ‡æ¢æ§ä»¶åŠ è½½å¤±è´¥', 'error');
            }
        }
        
        // æ·»åŠ å…¨å±æ§ä»¶ - ä¼˜åŒ–ç‰ˆæœ¬
        function addFullscreenControl(map) {
            try {
                // åˆ›å»ºå…¨å±åˆ‡æ¢æ§ä»¶
                const fullscreenControl = new AMap.Control({
                    position: 'RT',
                    offset: new AMap.Pixel(10, 70)
                });
                
                const controlContent = document.createElement('div');
                controlContent.className = 'fullscreen-control';
                controlContent.innerHTML = `
                    <div id="fullscreen-toggle" style="background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 10px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.2s ease; backdrop-filter: blur(10px);" title="å…¨å±æ˜¾ç¤º">
                        <i id="fullscreen-icon" class="fas fa-expand" style="font-size: 18px; color: #333; transition: transform 0.2s ease;"></i>
                    </div>
                `;
                
                fullscreenControl.content = controlContent;
                map.addControl(fullscreenControl);
                
                // ç»‘å®šå…¨å±äº‹ä»¶ - æ·»åŠ åŠ¨ç”»æ•ˆæœ
                const fullscreenToggle = controlContent.querySelector('#fullscreen-toggle');
                const fullscreenIcon = controlContent.querySelector('#fullscreen-icon');
                
                if (fullscreenToggle && fullscreenIcon) {
                    fullscreenToggle.addEventListener('click', () => {
                        toggleFullscreen('attractions-map', fullscreenIcon);
                    });
                    
                    // æ·»åŠ æ‚¬åœæ•ˆæœ
                    fullscreenToggle.addEventListener('mouseenter', () => {
                        fullscreenToggle.style.background = 'rgba(255,255,255,1)';
                        fullscreenToggle.style.transform = 'scale(1.05)';
                        fullscreenIcon.style.transform = 'scale(1.1)';
                    });
                    
                    fullscreenToggle.addEventListener('mouseleave', () => {
                        fullscreenToggle.style.background = 'rgba(255,255,255,0.95)';
                        fullscreenToggle.style.transform = 'scale(1)';
                        fullscreenIcon.style.transform = 'scale(1)';
                    });
                    
                    // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
                    document.addEventListener('fullscreenchange', () => {
                        if (document.fullscreenElement) {
                            fullscreenIcon.className = 'fas fa-compress';
                            fullscreenToggle.title = 'é€€å‡ºå…¨å±';
                        } else {
                            fullscreenIcon.className = 'fas fa-expand';
                            fullscreenToggle.title = 'å…¨å±æ˜¾ç¤º';
                        }
                        
                        // é‡æ–°è°ƒæ•´åœ°å›¾å¤§å°
                        setTimeout(() => {
                            if (window.currentMap) {
                                window.currentMap.resize();
                            }
                        }, 100);
                    });
                }
                
            } catch (error) {
                console.error('æ·»åŠ å…¨å±æ§ä»¶å¤±è´¥:', error);
                showNotification('å…¨å±æ§ä»¶åŠ è½½å¤±è´¥', 'error');
            }
        }
        
        // å…¨å±åˆ‡æ¢åŠŸèƒ½ - ä¼˜åŒ–ç‰ˆæœ¬
        function toggleFullscreen(elementId, iconElement) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (!document.fullscreenElement) {
                // è¿›å…¥å…¨å±
                const requestFullscreen = element.requestFullscreen || 
                                        element.webkitRequestFullscreen || 
                                        element.msRequestFullscreen;
                
                if (requestFullscreen) {
                    requestFullscreen.call(element).then(() => {
                        // å…¨å±æˆåŠŸï¼Œæ›´æ–°å›¾æ ‡
                        if (iconElement) {
                            iconElement.className = 'fas fa-compress';
                        }
                        // é‡æ–°è°ƒæ•´åœ°å›¾å¤§å°
                        setTimeout(() => {
                            if (window.currentMap) {
                                window.currentMap.resize();
                            }
                        }, 300);
                    }).catch(err => {
                        console.error('è¿›å…¥å…¨å±å¤±è´¥:', err);
                        showNotification('å…¨å±åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™', 'error');
                    });
                } else {
                    showNotification('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå…¨å±åŠŸèƒ½', 'warning');
                }
            } else {
                // é€€å‡ºå…¨å±
                const exitFullscreen = document.exitFullscreen || 
                                     document.webkitExitFullscreen || 
                                     document.msExitFullscreen;
                
                if (exitFullscreen) {
                    exitFullscreen.call(document).then(() => {
                        // é€€å‡ºå…¨å±æˆåŠŸï¼Œæ›´æ–°å›¾æ ‡
                        if (iconElement) {
                            iconElement.className = 'fas fa-expand';
                        }
                        // é‡æ–°è°ƒæ•´åœ°å›¾å¤§å°
                        setTimeout(() => {
                            if (window.currentMap) {
                                window.currentMap.resize();
                            }
                        }, 300);
                    }).catch(err => {
                        console.error('é€€å‡ºå…¨å±å¤±è´¥:', err);
                    });
                }
            }
        }
        
        // åˆ›å»ºèšåˆæ ‡è®° - ä¼˜åŒ–ç‰ˆæœ¬
        function createClusteredMarkers(map, attractions) {
            // åŠ¨æ€åŠ è½½MarkerClustereræ’ä»¶
            AMap.plugin(['AMap.MarkerCluster'], function() {
                // æ‰¹é‡åˆ›å»ºæ ‡è®°ï¼Œæé«˜æ€§èƒ½
                const markers = [];
                const infoWindows = [];
                
                // é¢„åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹ï¼Œå‡å°‘é‡å¤DOMæ“ä½œ
                attractions.forEach((attraction, index) => {
                    const position = [parseFloat(attraction.longitude), parseFloat(attraction.latitude)];
                    
                    // åˆ›å»ºæ ‡è®°
                    const marker = new AMap.Marker({
                        position: position,
                        title: attraction.name,
                        extData: {
                            attraction: attraction,
                            index: index
                        }
                    });
                    
                    // é¢„åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹
                    const infoWindowContent = `
                        <div style="padding: 12px; max-width: 300px; min-width: 200px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <i class="fas fa-map-marker-alt" style="color: #ff6b6b; margin-right: 8px;"></i>
                                <h4 style="margin: 0; color: #333; font-size: 16px; font-weight: bold;">${attraction.name}</h4>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="color: #ffa500; margin-right: 10px;">
                                    <i class="fas fa-star"></i> ${attraction.rating || 'æš‚æ— è¯„åˆ†'}
                                </span>
                                <span style="color: #666; font-size: 14px;">
                                    <i class="fas fa-tag"></i> ${attraction.category || 'æ™¯ç‚¹'}
                                </span>
                            </div>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px; line-height: 1.4;">${attraction.description || 'æš‚æ— æè¿°'}</p>
                            ${attraction.address ? `<div style="color: #888; font-size: 12px; margin-bottom: 8px;">
                                <i class="fas fa-location-arrow"></i> ${attraction.address}
                            </div>` : ''}
                            <div style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;">
                                <button onclick="window.openDirections('${attraction.name}', '${attraction.longitude}', '${attraction.latitude}')" 
                                        style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 8px;">
                                    <i class="fas fa-directions"></i> å¯¼èˆª
                                </button>
                                <button onclick="window.viewAttractionDetails('${attraction.name}')" 
                                        style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-info-circle"></i> è¯¦æƒ…
                                </button>
                            </div>
                        </div>
                    `;
                    
                    marker.infoWindowContent = infoWindowContent;
                    markers.push(marker);
                });
                
                // åˆ›å»ºèšåˆå®ä¾‹ - å¢å¼ºç‰ˆ
                const cluster = new AMap.MarkerCluster(map, markers, {
                    gridSize: 60,
                    maxZoom: 16,
                    minClusterSize: 2,
                    averageCenter: true,
                    styles: [{
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTMiIGhlaWdodD0iNTMiIHZpZXdCb3g9IjAgMCA1MyA1MyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxjaXJjbGUgY3g9IjI2LjUiIGN5PSIyNi41IiByPSIyNi41IiBmaWxsPSIjRkY2QjZCIiBvcGFjaXR5PSIwLjgiLz4KICAgIDx0ZXh0IHg9IjI2LjUiIHk9IjMyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsIj57Y2x1c3Rlcl9jb3VudH08L3RleHQ+Cjwvc3ZnPgo=',
                        size: new AMap.Size(53, 53),
                        offset: new AMap.Pixel(-26, -26),
                        textColor: '#ffffff',
                        textSize: 14
                    }]
                });
                
                // ä¸ºèšåˆåçš„æ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶ - å¢å¼ºç‰ˆ
                cluster.on('click', function(item) {
                    if (item.markers && item.markers.length === 1) {
                        // å•ä¸ªæ ‡è®°è¢«ç‚¹å‡»
                        const marker = item.markers[0];
                        const infoWindow = new AMap.InfoWindow({
                            content: marker.infoWindowContent,
                            offset: new AMap.Pixel(0, -40),
                            autoMove: true,
                            closeWhenClickMap: true,
                            maxWidth: 350
                        });
                        
                        // å…³é—­å…¶ä»–ä¿¡æ¯çª—å£
                        if (window.currentInfoWindows) {
                            window.currentInfoWindows.forEach(win => win.close());
                        }
                        
                        infoWindow.open(map, marker);
                        
                        // ä¿å­˜å½“å‰ä¿¡æ¯çª—å£å¼•ç”¨
                        if (!window.currentInfoWindows) {
                            window.currentInfoWindows = [];
                        }
                        window.currentInfoWindows.push(infoWindow);
                        
                        // åœ°å›¾å±…ä¸­åˆ°æ ‡è®°ä½ç½®ï¼Œå¸¦æœ‰åŠ¨ç”»æ•ˆæœ
                        map.panTo(marker.getPosition(), {
                            duration: 500,
                            delay: 0
                        });
                    } else if (item.markers && item.markers.length > 1) {
                        // èšåˆæ ‡è®°è¢«ç‚¹å‡»ï¼Œè‡ªåŠ¨æ”¾å¤§åœ°å›¾
                        const bounds = new AMap.Bounds();
                        item.markers.forEach(marker => {
                            bounds.extend(marker.getPosition());
                        });
                        map.setBounds(bounds, {
                            padding: [20, 20, 20, 20],
                            duration: 500
                        });
                    }
                });
                
                // ä¸ºæœªèšåˆçš„æ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶ - å¢å¼ºç‰ˆ
                markers.forEach(marker => {
                    // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                    marker.on('mouseover', function() {
                        this.setIcon(new AMap.Icon({
                            size: new AMap.Size(36, 44),
                            image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iNDQiIHZpZXdCb3g9IjAgMCAzNiA0NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE4IDBDOC4wNTg4NyAwIDAgOC4wNTg4NyAwIDE4QzAgMjcuOTQxMSA4LjA1ODg3IDM2IDE4IDM2QzI3Ljk0MTEgMzYgMzYgMjcuOTQxMSAzNiAxOEMzNiA4LjA1ODg3IDI3Ljk0MTEgMCAxOCAwWiIgZmlsbD0iIzAwN2JmZiIvPgo8cGF0aCBkPSJNMTggMzZMMjcgMThIMThIMThMMTggMzZaIiBmaWxsPSIjMDA3YmZmIi8+CjxjaXJjbGUgY3g9IjE4IiBjeT0iMTgiIHI9IjkiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                            imageSize: new AMap.Size(36, 44),
                            imageOffset: new AMap.Pixel(-18, -44)
                        }));
                        this.setOffset(new AMap.Pixel(-18, -44));
                        this.setzIndex(1000);
                    });
                    
                    marker.on('mouseout', function() {
                        this.setIcon(new AMap.Icon({
                            size: new AMap.Size(32, 40),
                            image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAzMiA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDBDNy4xNjM0NCAwIDAgNy4xNjM0NCAwIDE2QzAgMjQuODM2NiA3LjE2MzQ0IDMyIDE2IDMyQzI0LjgzNjYgMzIgMzIgMjQuODM2NiAzMiAxNkMzMiA3LjE2MzQ0IDI0LjgzNjYgMCAxNiAwWiIgZmlsbD0iIzAwN2JmZiIvPgo8cGF0aCBkPSJNMTYgMzJMMjQgMTZIMTZIMTZMMTYgMzJaIiBmaWxsPSIjMDA3YmZmIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjgiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                            imageSize: new AMap.Size(32, 40),
                            imageOffset: new AMap.Pixel(-16, -40)
                        }));
                        this.setOffset(new AMap.Pixel(-16, -40));
                        this.setzIndex(100);
                    });
                    
                    marker.on('click', function() {
                        // å…³é—­å…¶ä»–ä¿¡æ¯çª—å£
                        if (window.currentInfoWindows) {
                            window.currentInfoWindows.forEach(win => win.close());
                        }
                        
                        const infoWindow = new AMap.InfoWindow({
                            content: this.infoWindowContent,
                            offset: new AMap.Pixel(0, -40),
                            autoMove: true,
                            closeWhenClickMap: true,
                            maxWidth: 350
                        });
                        
                        infoWindow.open(map, this);
                        
                        // ä¿å­˜å½“å‰ä¿¡æ¯çª—å£å¼•ç”¨
                        if (!window.currentInfoWindows) {
                            window.currentInfoWindows = [];
                        }
                        window.currentInfoWindows.push(infoWindow);
                        
                        // ä¿å­˜æ ‡è®°å¼•ç”¨
                        if (!window.currentMarkers) {
                            window.currentMarkers = [];
                        }
                        window.currentMarkers.push(this);
                        
                        // åœ°å›¾å±…ä¸­åˆ°æ ‡è®°ä½ç½®ï¼Œå¸¦æœ‰åŠ¨ç”»æ•ˆæœ
                        map.panTo(this.getPosition(), {
                            duration: 500,
                            delay: 0
                        });
                    });
                });
                
                // ä¿å­˜æ ‡è®°å¼•ç”¨ä¾›åç»­ä½¿ç”¨
                if (!window.currentMarkers) {
                    window.currentMarkers = [];
                }
                window.currentMarkers = markers;
                
            });
        }
        
        // åˆ›å»ºå•ç‹¬æ ‡è®° - ä¼˜åŒ–ç‰ˆæœ¬
        function createIndividualMarkers(map, attractions) {
            // é¢„åˆ›å»ºæ‰€æœ‰ä¿¡æ¯çª—å£å†…å®¹ï¼Œæé«˜æ€§èƒ½
            const infoWindows = [];
            const markers = [];
            
            // æ‰¹é‡åˆ›å»ºæ ‡è®°ï¼Œå‡å°‘DOMæ“ä½œ
            attractions.forEach((attraction, index) => {
                const position = [parseFloat(attraction.longitude), parseFloat(attraction.latitude)];
                
                // é¢„åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹ - å¢å¼ºç‰ˆ
                const infoWindowContent = `
                    <div style="padding: 12px; max-width: 300px; min-width: 200px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #ff6b6b; margin-right: 8px; font-size: 18px;"></i>
                            <h4 style="margin: 0; color: #333; font-size: 16px; font-weight: bold;">${attraction.name}</h4>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #ffa500; margin-right: 10px; font-weight: 500;">
                                <i class="fas fa-star"></i> ${attraction.rating || 'æš‚æ— è¯„åˆ†'}
                            </span>
                            <span style="color: #666; font-size: 14px;">
                                <i class="fas fa-tag"></i> ${attraction.category || 'æ™¯ç‚¹'}
                            </span>
                        </div>
                        <p style="margin: 0 0 8px 0; color: #666; font-size: 14px; line-height: 1.4;">${attraction.description || 'æš‚æ— æè¿°'}</p>
                        ${attraction.address ? `<div style="color: #888; font-size: 12px; margin-bottom: 8px;">
                            <i class="fas fa-location-arrow"></i> ${attraction.address}
                        </div>` : ''}
                        <div style="border-top: 1px solid #f0f0f0; padding-top: 8px; margin-top: 8px; display: flex; gap: 8px;">
                            <button onclick="window.openDirections('${attraction.name}', '${attraction.longitude}', '${attraction.latitude}')" 
                                    style="flex: 1; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,123,255,0.2);">
                                <i class="fas fa-directions"></i> å¯¼èˆª
                            </button>
                            <button onclick="window.viewAttractionDetails('${attraction.name}')" 
                                    style="flex: 1; background: linear-gradient(135deg, #28a745, #1e7e34); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(40,167,69,0.2);">
                                <i class="fas fa-info-circle"></i> è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                `;
                
                // åˆ›å»ºæ ‡è®° - æ·»åŠ è‡ªå®šä¹‰å›¾æ ‡
                const marker = new AMap.Marker({
                    position: position,
                    title: attraction.name,
                    map: map,
                    // è‡ªå®šä¹‰å›¾æ ‡ - æ›´ç¾è§‚çš„æ ‡è®°
                    icon: new AMap.Icon({
                        size: new AMap.Size(32, 40),
                        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAzMiA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDBDNy4xNjM0NCAwIDAgNy4xNjM0NCAwIDE2QzAgMjQuODM2NiA3LjE2MzQ0IDMyIDE2IDMyQzI0LjgzNjYgMzIgMzIgMjQuODM2NiAzMiAxNkMzMiA3LjE2MzQ0IDI0LjgzNjYgMCAxNiAwWiIgZmlsbD0iI0ZGNkI2QiIvPgo8cGF0aCBkPSJNMTYgMzJMMjQgMTZIMTZIMTZMMTYgMzJaIiBmaWxsPSIjRkY2QjZCIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjgiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                        imageSize: new AMap.Size(32, 40),
                        imageOffset: new AMap.Pixel(-16, -40)
                    }),
                    offset: new AMap.Pixel(-16, -40),
                    extData: {
                        attraction: attraction,
                        index: index,
                        infoWindowContent: infoWindowContent
                    }
                });
                
                markers.push(marker);
            });
            
            // æ‰¹é‡ç»‘å®šäº‹ä»¶ï¼Œæé«˜æ€§èƒ½ - æ·»åŠ æ›´å¤šäº¤äº’åŠŸèƒ½
            setTimeout(() => {
                markers.forEach((marker, index) => {
                    const infoWindow = new AMap.InfoWindow({
                        content: marker.getExtData().infoWindowContent,
                        offset: new AMap.Pixel(0, -40),
                        autoMove: true,
                        closeWhenClickMap: true,
                        maxWidth: 350
                    });
                    
                    marker.on('click', function() {
                        // å…³é—­å…¶ä»–ä¿¡æ¯çª—å£
                        if (window.currentInfoWindows) {
                            window.currentInfoWindows.forEach(win => win.close());
                        }
                        
                        infoWindow.open(map, this);
                        
                        // ä¿å­˜å½“å‰ä¿¡æ¯çª—å£å¼•ç”¨
                        if (!window.currentInfoWindows) {
                            window.currentInfoWindows = [];
                        }
                        window.currentInfoWindows.push(infoWindow);
                        
                        // åœ°å›¾å±…ä¸­åˆ°æ ‡è®°ä½ç½®ï¼Œå¸¦æœ‰åŠ¨ç”»æ•ˆæœ
                        map.panTo(this.getPosition(), {
                            duration: 500,
                            delay: 0
                        });
                    });
                    
                    // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                    marker.on('mouseover', function() {
                        this.setIcon(new AMap.Icon({
                            size: new AMap.Size(36, 44),
                            image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iNDQiIHZpZXdCb3g9IjAgMCAzNiA0NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE4IDBDOC4wNTg4NyAwIDAgOC4wNTg4NyAwIDE4QzAgMjcuOTQxMSA4LjA1ODg3IDM2IDE4IDM2QzI3Ljk0MTEgMzYgMzYgMjcuOTQxMSAzNiAxOEMzNiA4LjA1ODg3IDI3Ljk0MTEgMCAxOCAwWiIgZmlsbD0iI0ZGNkI2QiIvPgo8cGF0aCBkPSJNMTggMzZMMjcgMThIMThIMThMMTggMzZaIiBmaWxsPSIjRkY2QjZCIi8+CjxjaXJjbGUgY3g9IjE4IiBjeT0iMTgiIHI9IjkiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                            imageSize: new AMap.Size(36, 44),
                            imageOffset: new AMap.Pixel(-18, -44)
                        }));
                        this.setOffset(new AMap.Pixel(-18, -44));
                        this.setzIndex(1000); // æé«˜å±‚çº§
                    });
                    
                    marker.on('mouseout', function() {
                        this.setIcon(new AMap.Icon({
                            size: new AMap.Size(32, 40),
                            image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAzMiA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDBDNy4xNjM0NCAwIDAgNy4xNjM0NCAwIDE2QzAgMjQuODM2NiA3LjE2MzQ0IDMyIDE2IDMyQzI0LjgzNjYgMzIgMzIgMjQuODM2NiAzMiAxNkMzMiA3LjE2MzQ0IDI0LjgzNjYgMCAxNiAwWiIgZmlsbD0iI0ZGNkI2QiIvPgo8cGF0aCBkPSJNMTYgMzJMMjQgMTZIMTZIMTZMMTYgMzJaIiBmaWxsPSIjRkY2QjZCIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjgiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                            imageSize: new AMap.Size(32, 40),
                            imageOffset: new AMap.Pixel(-16, -40)
                        }));
                        this.setOffset(new AMap.Pixel(-16, -40));
                        this.setzIndex(100); // æ¢å¤å±‚çº§
                    });
                    
                    infoWindows.push(infoWindow);
                });
                
                // ä¿å­˜ä¿¡æ¯çª—å£å¼•ç”¨ï¼Œä¾¿äºåç»­ç®¡ç†
                window.attractionInfoWindows = infoWindows;
                window.currentMarkers = markers;
                
            }, 100); // å»¶è¿Ÿç»‘å®šäº‹ä»¶ï¼Œé¿å…é˜»å¡UI
        }
        // æ·»åŠ åœ°å›¾æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
        function optimizeMapPerformance(map) {
            // ç›‘å¬åœ°å›¾ç§»åŠ¨äº‹ä»¶ï¼Œä¼˜åŒ–æ ‡è®°æ˜¾ç¤º
            let moveTimer;
            map.on('movestart', function() {
                if (window.currentMarkers) {
                    window.currentMarkers.forEach(marker => {
                        marker.setOpacity(0.7); // ç§»åŠ¨æ—¶é™ä½é€æ˜åº¦
                    });
                }
            });
            
            map.on('moveend', function() {
                clearTimeout(moveTimer);
                moveTimer = setTimeout(() => {
                    if (window.currentMarkers) {
                        window.currentMarkers.forEach(marker => {
                            marker.setOpacity(1); // ç§»åŠ¨ç»“æŸåæ¢å¤é€æ˜åº¦
                        });
                    }
                }, 300);
            });
            
            // ç›‘å¬ç¼©æ”¾äº‹ä»¶ï¼Œä¼˜åŒ–æ€§èƒ½
            let zoomTimer;
            map.on('zoomstart', function() {
                if (window.currentInfoWindows) {
                    window.currentInfoWindows.forEach(win => win.close()); // ç¼©æ”¾æ—¶å…³é—­ä¿¡æ¯çª—å£
                }
            });
            
            map.on('zoomend', function() {
                clearTimeout(zoomTimer);
                zoomTimer = setTimeout(() => {
                    console.log('åœ°å›¾ç¼©æ”¾çº§åˆ«:', map.getZoom());
                }, 300);
            });
        }
        
        // æ·»åŠ åœ°å›¾å·¥å…·å‡½æ•°
        window.openDirections = function(name, longitude, latitude) {
            // æ‰“å¼€å¯¼èˆª - æ”¯æŒå¤šç§åœ°å›¾æœåŠ¡
            const url = `https://uri.amap.com/navigation?to=${longitude},${latitude},${name}&mode=car&policy=1&src=myapp&coordinate=gaode&callnative=0`;
            window.open(url, '_blank');
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (window.notificationManager) {
                window.notificationManager.success('æ­£åœ¨æ‰“å¼€å¯¼èˆª...', 'å¯¼èˆª');
            }
        };
        
        window.viewAttractionDetails = function(name) {
            // æŸ¥çœ‹æ™¯ç‚¹è¯¦æƒ… - å¯ä»¥è·³è½¬åˆ°è¯¦æƒ…é¡µé¢æˆ–æ˜¾ç¤ºæ¨¡æ€æ¡†
            console.log('æŸ¥çœ‹æ™¯ç‚¹è¯¦æƒ…:', name);
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (window.notificationManager) {
                window.notificationManager.info(`æ­£åœ¨åŠ è½½ "${name}" çš„è¯¦ç»†ä¿¡æ¯...`, 'è¯¦æƒ…');
            }
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ è·³è½¬åˆ°è¯¦æƒ…é¡µçš„é€»è¾‘
            // window.location.href = `/attraction/${encodeURIComponent(name)}`;
        };
        
        // æ·»åŠ åœ°å›¾æœç´¢åŠŸèƒ½
        function addMapSearchControl(map) {
            // åˆ›å»ºæœç´¢æ§ä»¶
            const searchControl = new AMap.Control({
                position: 'LT'
            });
            
            // åˆ›å»ºæœç´¢æ¡†DOM
            const searchDiv = document.createElement('div');
            searchDiv.className = 'map-search-control';
            searchDiv.innerHTML = `
                <div style="position: relative; margin: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <input type="text" id="mapSearchInput" placeholder="æœç´¢æ™¯ç‚¹..." 
                           style="width: 200px; padding: 10px 40px 10px 15px; border: none; outline: none; font-size: 14px;">
                    <button onclick="window.searchAttractions()" 
                            style="position: absolute; right: 0; top: 0; width: 40px; height: 100%; border: none; background: #007bff; color: white; cursor: pointer; transition: background 0.2s ease;">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="searchResults" style="max-height: 200px; overflow-y: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 0 10px; display: none;"></div>
            `;
            
            searchControl.container = searchDiv;
            map.addControl(searchControl);
            
            // æ·»åŠ å›è½¦é”®æœç´¢æ”¯æŒ
            const searchInput = document.getElementById('mapSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        window.searchAttractions();
                    }
                });
            }
        }
        
        // æœç´¢æ™¯ç‚¹åŠŸèƒ½
        window.searchAttractions = function() {
            const searchInput = document.getElementById('mapSearchInput');
            const searchResults = document.getElementById('searchResults');
            
            if (!searchInput || !searchResults) return;
            
            const query = searchInput.value.trim();
            if (!query) {
                searchResults.style.display = 'none';
                return;
            }
            
            // æœç´¢é€»è¾‘
            if (window.currentMarkers) {
                const results = window.currentMarkers.filter(marker => {
                    const attraction = marker.getExtData().attraction;
                    return attraction && attraction.name && attraction.name.toLowerCase().includes(query.toLowerCase());
                });
                
                if (results.length > 0) {
                    let resultsHTML = '';
                    results.forEach(marker => {
                        const attraction = marker.getExtData().attraction;
                        resultsHTML += `
                            <div onclick="window.focusOnMarker(${marker.getExtData().index})" 
                                 style="padding: 10px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s ease;"
                                 onmouseover="this.style.background='#f8f9fa'" 
                                 onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; color: #333; margin-bottom: 4px;">${attraction.name}</div>
                                <div style="font-size: 12px; color: #666;">${attraction.category || 'æ™¯ç‚¹'} | ${attraction.rating || 'æš‚æ— è¯„åˆ†'}</div>
                            </div>
                        `;
                    });
                    
                    searchResults.innerHTML = resultsHTML;
                    searchResults.style.display = 'block';
                } else {
                    searchResults.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">æœªæ‰¾åˆ°ç›¸å…³æ™¯ç‚¹</div>';
                    searchResults.style.display = 'block';
                }
            }
        };
        
        // èšç„¦åˆ°æŒ‡å®šæ ‡è®°
        window.focusOnMarker = function(index) {
            if (window.currentMarkers && window.currentMarkers[index]) {
                const marker = window.currentMarkers[index];
                const map = marker.getMap();
                
                // å…³é—­æœç´¢ç»“æœ
                const searchResults = document.getElementById('searchResults');
                if (searchResults) {
                    searchResults.style.display = 'none';
                }
                
                // è§¦å‘æ ‡è®°ç‚¹å‡»äº‹ä»¶
                marker.emit('click', {target: marker});
                
                // åœ°å›¾å±…ä¸­å¹¶æ”¾å¤§
                map.setZoomAndCenter(16, marker.getPosition(), true, 500);
            }
        };
        
        // æ·»åŠ åœ°å›¾ç»Ÿè®¡ä¿¡æ¯
        function addMapStats(map, attractions) {
            const statsControl = new AMap.Control({
                position: 'RB'
            });
            
            const statsDiv = document.createElement('div');
            statsDiv.className = 'map-stats-control';
            statsDiv.innerHTML = `
                <div style="background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; margin: 10px;">
                    <div style="margin-bottom: 4px;"><i class="fas fa-map-marker-alt"></i> æ™¯ç‚¹æ•°é‡: ${attractions.length}</div>
                    <div style="margin-bottom: 4px;"><i class="fas fa-search-plus"></i> ç¼©æ”¾çº§åˆ«: <span id="zoomLevel">${map.getZoom()}</span></div>
                    <div><i class="fas fa-crosshairs"></i> ä¸­å¿ƒåæ ‡: ${map.getCenter().toString()}</div>
                </div>
            `;
            
            statsControl.container = statsDiv;
            map.addControl(statsControl);
            
            // ç›‘å¬ç¼©æ”¾å˜åŒ–
            map.on('zoomend', function() {
                const zoomLevelSpan = document.getElementById('zoomLevel');
                if (zoomLevelSpan) {
                    zoomLevelSpan.textContent = map.getZoom();
                }
            });
        }
    </script>
</body>
</html>