<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è¡Œè®¡åˆ’åŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="date"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        .plan-result {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section {
            margin-bottom: 25px;
        }
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 10px;
        }
        .weather-day {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .attraction-item {
            background: #f0f8e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
        }
        
        /* AIå¢å¼ºç›¸å…³æ ·å¼ */
        .ai-enhanced-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .ai-description {
            position: relative;
        }
        
        .source-tag {
            font-size: 0.8em;
            color: #667eea;
            margin-left: 5px;
        }
        
        .ai-optimized-route {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .optimization-badge {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .original-route-toggle {
            background: #eee;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .original-route-toggle:hover {
            background: #ddd;
        }
        
        .original-route {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }
        
        .ai-enhanced-tag {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .ai-suggestions {
            background: #f0f8e8;
            padding: 15px;
            border-radius: 5px;
        }
        
        /* èŠå¤©ç•Œé¢æ ·å¼ */
        #chat-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            max-width: 85%;
        }
        
        .chat-message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-bottom-right-radius: 2px;
        }
        
        .chat-message.ai {
            align-self: flex-start;
            background: #f0f0f0;
            border-bottom-left-radius: 2px;
        }
        
        .chat-message.ai.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .message-avatar {
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .message-content {
            flex: 1;
            overflow-wrap: break-word;
        }
        
        .agent-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .response-text {
            line-height: 1.5;
        }
        
        .ai-tag {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* æ‰“å­—æŒ‡ç¤ºå™¨ */
        .typing-indicator {
            display: flex;
            gap: 5px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite both;
        }
        
        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0% {
                transform: translateY(0);
                opacity: 0.4;
            }
            50% {
                transform: translateY(-5px);
                opacity: 1;
            }
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }
        }
        .route-day {
            background: #fff3e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .route-spot {
            margin-left: 20px;
            margin-top: 10px;
        }
        .suggestion-item {
            background: #f8e8f8;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        .error {
            background: #ffe8e8;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #666;
        }
        .tab.active {
            border-bottom: 3px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .attraction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .attraction-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .attraction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .attraction-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
        }
        .attraction-rating {
            color: #ff9800;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .btn-secondary {
            background: #7f8c8d;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>âœ¨ æ—…è¡Œè®¡åˆ’æ™ºèƒ½åŠ©æ‰‹ âœ¨</h1>
        <p>è®©AIä¸ºæ‚¨è§„åˆ’å®Œç¾æ—…ç¨‹ï¼Œæ•´åˆå¤©æ°”ã€æ™¯ç‚¹ã€çº¿è·¯å’Œæ”»ç•¥ä¿¡æ¯</p>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('plan-tab', this)">ğŸ“… åˆ›å»ºæ—…è¡Œè®¡åˆ’</button>
            <button class="tab" onclick="switchTab('attractions-tab', this)">ğŸï¸ æ™¯ç‚¹æŸ¥è¯¢</button>
            <button class="tab" onclick="switchTab('chat-tab', this)">ğŸ’¬ æ™ºèƒ½é—®ç­”</button>
        </div>

        <!-- æ—…è¡Œè®¡åˆ’é€‰é¡¹å¡ -->
        <div id="plan-tab" class="tab-content active">
            <form id="plan-form">
                <div class="form-group">
                    <label for="city">ç›®çš„åœ°åŸå¸‚</label>
                    <input type="text" id="city" name="city" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ­å·" required>
                </div>
                
                <div class="form-group">
                    <label for="start-date">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="start-date" name="start-date">
                </div>
                
                <div class="form-group">
                    <label for="days">æ—…è¡Œå¤©æ•°</label>
                    <select id="days" name="days">
                        <option value="1">1å¤©</option>
                        <option value="2">2å¤©</option>
                        <option value="3" selected>3å¤©</option>
                        <option value="4">4å¤©</option>
                        <option value="5">5å¤©</option>
                        <option value="6">6å¤©</option>
                        <option value="7">7å¤©</option>
                    </select>
                </div>
                
                <button type="submit">ç”Ÿæˆæ—…è¡Œè®¡åˆ’</button>
            </form>

            <div id="plan-result" class="plan-result" style="display: none;">
                <h3 id="plan-title"></h3>
                
                <!-- å¤©æ°”ä¿¡æ¯ -->
                <div class="section">
                    <div class="section-title">ğŸ“… å¤©æ°”é¢„æŠ¥</div>
                    <div id="weather-forecast"></div>
                </div>
                
                <!-- æ™¯ç‚¹æ¨è -->
                <div class="section">
                    <div class="section-title">ğŸï¸ çƒ­é—¨æ™¯ç‚¹</div>
                    <div id="attractions-list"></div>
                </div>
                
                <!-- è¡Œç¨‹å®‰æ’ -->
                <div class="section">
                    <div class="section-title">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹</div>
                    <div id="daily-routes"></div>
                </div>
                
                <!-- æ—…è¡Œå»ºè®® -->
                <div class="section">
                    <div class="section-title">ğŸ’¡ æ—…è¡Œå»ºè®®</div>
                    <div id="travel-suggestions"></div>
                </div>
            </div>
        </div>

        <!-- æ™¯ç‚¹æŸ¥è¯¢é€‰é¡¹å¡ -->
        <div id="attractions-tab" class="tab-content">
            <form id="attractions-form">
                <div class="form-group">
                    <label for="attraction-city">åŸå¸‚åç§°</label>
                    <input type="text" id="attraction-city" name="attraction-city" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ­å·" required>
                </div>
                
                <div class="form-group">
                    <label for="attraction-limit">æ˜¾ç¤ºæ•°é‡</label>
                    <select id="attraction-limit" name="attraction-limit">
                        <option value="5">5ä¸ª</option>
                        <option value="10" selected>10ä¸ª</option>
                        <option value="15">15ä¸ª</option>
                        <option value="20">20ä¸ª</option>
                    </select>
                </div>
                
                <button type="submit">æŸ¥è¯¢æ™¯ç‚¹</button>
            </form>

            <div id="attractions-result" style="display: none;">
                <h3 id="attractions-title"></h3>
                <div id="attractions-grid" class="attraction-grid"></div>
            </div>
        </div>

        <!-- æ™ºèƒ½é—®ç­”é€‰é¡¹å¡ -->
        <div id="chat-tab" class="tab-content">
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong></p>
                <ul>
                    <li>æŸ¥è¯¢å¤©æ°”ï¼šä¾‹å¦‚ "åŒ—äº¬æ˜å¤©å¤©æ°”å¦‚ä½•ï¼Ÿ"</li>
                    <li>æŸ¥è¯¢æ™¯ç‚¹ï¼šä¾‹å¦‚ "ä¸Šæµ·æœ‰å“ªäº›å¥½ç©çš„æ™¯ç‚¹ï¼Ÿ"</li>
                    <li>åˆ›å»ºæ—…è¡Œè®¡åˆ’ï¼šä¾‹å¦‚ "å¸®æˆ‘è§„åˆ’3å¤©åŒ—äº¬æ—…æ¸¸è¡Œç¨‹"</li>
                    <li>æŸ¥è¯¢æ”»ç•¥ï¼šä¾‹å¦‚ "æ­å·æ—…æ¸¸æ”»ç•¥æœ‰å“ªäº›ï¼Ÿ"</li>
                </ul>
            </div>
            
            <div id="chat-container" style="border: 1px solid #ddd; border-radius: 8px; height: 400px; overflow-y: auto; padding: 20px; margin-bottom: 20px;"></div>
            
            <form id="chat-form">
                <input type="text" id="chat-query" name="chat-query" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." style="width: calc(100% - 100px); display: inline-block;">
                <button type="submit" style="width: 80px; margin-left: 10px;">å‘é€</button>
            </form>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div style="text-align: center; padding: 20px;">
                <h3>æ­£åœ¨ç”Ÿæˆæ—…è¡Œè®¡åˆ’</h3>
                <div style="margin: 20px 0; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div style="width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; overflow: hidden;">
                        <div id="progress-bar" style="width: 0%; height: 100%; background-color: #4CAF50; transition: width 0.3s ease;"></div>
                    </div>
                    <p id="progress-status" style="text-align: center; margin-top: 10px; font-size: 14px; color: #666;">åˆå§‹åŒ–...</p>
                    <p id="progress-time" style="text-align: center; margin-top: 5px; font-size: 12px; color: #999;">é¢„è®¡å‰©ä½™æ—¶é—´: è®¡ç®—ä¸­...</p>
                </div>
                <div style="font-size: 12px; color: #888;">
                    <p>ä¸ºæ‚¨æä¾›æœ€ä½³æ—…è¡Œä½“éªŒï¼Œæˆ‘ä»¬æ­£åœ¨è¿›è¡Œä»¥ä¸‹å·¥ä½œï¼š</p>
                    <ul style="text-align: left; max-width: 400px; margin: 10px auto;">
                        <li id="step-1" style="color: #4CAF50;">âœ“ åˆ†æç›®çš„åœ°ä¿¡æ¯</li>
                        <li id="step-2" style="color: #999;">â–¡ è·å–å¤©æ°”æ•°æ®</li>
                        <li id="step-3" style="color: #999;">â–¡ ç­›é€‰çƒ­é—¨æ™¯ç‚¹</li>
                        <li id="step-4" style="color: #999;">â–¡ è§„åˆ’è¡Œç¨‹è·¯çº¿</li>
                        <li id="step-5" style="color: #999;">â–¡ ç”Ÿæˆæ—…è¡Œå»ºè®®</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabId, tabButton) {
            // éšè—æ‰€æœ‰å†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹å’Œæ´»åŠ¨æ ‡ç­¾
            document.getElementById(tabId).classList.add('active');
            tabButton.classList.add('active');
        }

        // ç”Ÿæˆæ—…è¡Œè®¡åˆ’
        document.getElementById('plan-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const city = document.getElementById('city').value;
            const startDate = document.getElementById('start-date').value;
            const days = document.getElementById('days').value;
            
            // è¡¨å•éªŒè¯
            if (!city || !startDate || !days || parseInt(days) <= 0 || parseInt(days) > 7) {
                const errorContainer = document.getElementById('error-message') || document.createElement('div');
                errorContainer.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼Œä¸”å¤©æ•°å¿…é¡»åœ¨1-7å¤©ä¹‹é—´';
                errorContainer.style.display = 'block';
                errorContainer.className = 'error';
                // ç¡®ä¿é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºåœ¨é€‚å½“ä½ç½®
                const loadingElement = document.getElementById('loading');
                if (!document.getElementById('error-message')) {
                    loadingElement.parentNode.insertBefore(errorContainer, loadingElement.nextSibling);
                }
                return;
            }
            
            // é‡ç½®çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('plan-result').style.display = 'none';
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            console.log('å¼€å§‹ç”Ÿæˆæ—…è¡Œè®¡åˆ’è¯·æ±‚', { city, startDate, days });
            
            // åˆå§‹åŒ–è¿›åº¦æ›´æ–°
            let progress = 0;
            let startTime = new Date();
            const steps = ['åˆ†æç›®çš„åœ°ä¿¡æ¯', 'è·å–å¤©æ°”æ•°æ®', 'ç­›é€‰çƒ­é—¨æ™¯ç‚¹', 'è§„åˆ’è¡Œç¨‹è·¯çº¿', 'ç”Ÿæˆæ—…è¡Œå»ºè®®'];
            let currentStep = 0;
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°å‡½æ•°
            const updateProgress = () => {
                const elapsedTime = (new Date() - startTime) / 1000; // ç§’
                
                // æ ¹æ®å·²ç”¨æ—¶é—´æ¨¡æ‹Ÿè¿›åº¦ï¼Œç¡®ä¿åœ¨è¯·æ±‚å®Œæˆå‰è¾¾åˆ°æ¥è¿‘100%ä½†ä¸è¶…è¿‡100%
                if (progress < 90) {
                    // éçº¿æ€§è¿›åº¦å¢é•¿ï¼Œå¼€å§‹å¿«ä¸€ç‚¹ï¼Œåé¢æ…¢ä¸€ç‚¹
                    const progressIncrement = Math.max(1, (90 - progress) / 20);
                    progress += progressIncrement;
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    document.getElementById('progress-bar').style.width = progress + '%';
                    
                    // æ›´æ–°å½“å‰æ­¥éª¤å’ŒçŠ¶æ€
                    const stepIndex = Math.floor((progress / 90) * steps.length);
                    if (stepIndex > currentStep && stepIndex < steps.length) {
                        currentStep = stepIndex;
                        
                        // æ›´æ–°æ­¥éª¤çŠ¶æ€æ˜¾ç¤º (HTMLä½¿ç”¨1ç´¢å¼•ï¼Œéœ€è¦+1)
                        const htmlStepId = currentStep + 1;
                        if (htmlStepId > 1 && htmlStepId <= 5) { // åªæ›´æ–°æ­¥éª¤2-5
                            document.getElementById(`step-${htmlStepId}`).innerHTML = 'âœ“ ' + steps[currentStep];
                            document.getElementById(`step-${htmlStepId}`).style.color = '#4CAF50';
                        }
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                    document.getElementById('progress-status').textContent = `æ­£åœ¨${steps[Math.min(currentStep, steps.length - 1)]}...`;
                    
                    // ä¼°ç®—å‰©ä½™æ—¶é—´ï¼ˆåŸºäºå½“å‰è¿›åº¦å’Œå·²ç”¨æ—¶é—´ï¼‰
                    const estimatedTotalTime = (elapsedTime / progress) * 100;
                    const remainingTime = Math.max(0, estimatedTotalTime - elapsedTime);
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = Math.floor(remainingTime % 60);
                    document.getElementById('progress-time').textContent = 
                        `é¢„è®¡å‰©ä½™æ—¶é—´: ${minutes}åˆ†${seconds}ç§’`;
                }
            };
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
            const progressInterval = setInterval(updateProgress, 1000);
            
            // åˆ›å»ºä¸­æ­¢æ§åˆ¶å™¨ç”¨äºè¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.log('è¯·æ±‚è¶…æ—¶ï¼Œä¸­æ­¢è¯·æ±‚');
                controller.abort();
            }, 600000); // 600ç§’è¶…æ—¶ (å»¶é•¿æ—¶é—´ä»¥ç¡®ä¿APIè¯·æ±‚æœ‰è¶³å¤Ÿæ—¶é—´å®Œæˆ)
            
            // å‘é€è¯·æ±‚ï¼Œæ·»åŠ è¶…æ—¶æ§åˆ¶
            fetch('/api/travel-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    city: city,
                    start_date: startDate,
                    days: days
                }),
                signal: controller.signal // æ·»åŠ ä¸­æ­¢ä¿¡å·
            })
            .then(response => {
                clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                clearInterval(progressInterval); // æ¸…é™¤è¿›åº¦æ›´æ–°è®¡æ—¶å™¨
                
                // å®Œæˆè¿›åº¦æ˜¾ç¤º
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-status').textContent = 'å¤„ç†å®Œæˆï¼';
                document.getElementById('progress-time').textContent = 'æ­£åœ¨å‡†å¤‡ç»“æœ...';
                
                console.log('æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);
                
                if (!response.ok) {
                    throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                console.log('APIå“åº”æ•°æ®:', data);
                
                if (data.status === 'success') {
                    // æ˜¾ç¤ºç»“æœ
                    const planResult = document.getElementById('plan-result');
                    planResult.style.display = 'block';
                    
                    // æ·»åŠ AIå¢å¼ºæ ‡è®°
                    let planTitle = `${city} ${days}å¤©æ—…è¡Œè®¡åˆ’`;
                    if (data.enhanced_by_ai) {
                        planTitle += ' <span style="color: #667eea;">(AIæ™ºèƒ½å¢å¼º)</span>';
                    }
                    document.getElementById('plan-title').innerHTML = planTitle;
                    
                    // å¡«å……å¤©æ°”ä¿¡æ¯ - æ·»åŠ å®¹é”™å¤„ç†ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£å¸¸
                    const weatherContainer = document.getElementById('weather-forecast');
                    weatherContainer.innerHTML = '';
                    if (data.sections.weather_forecast) {
                        data.sections.weather_forecast.forEach(day => {
                            const weatherDay = document.createElement('div');
                            weatherDay.className = 'weather-day';
                            // æ·»åŠ å®¹é”™å¤„ç†ï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰é»˜è®¤å€¼
                            const dayName = day.day || 'æœªçŸ¥';
                            const dateStr = day.date || '';
                            const weather = day.weather || 'æ™´';
                            const tempMin = day.temp_min || '20';
                            const tempMax = day.temp_max || '28';
                            const suggestion = day.suggestion || 'é€‚åˆå‡ºæ¸¸ï¼Œè®°å¾—åšå¥½é˜²æ™’';
                            const aiSuggestion = day.ai_suggestion || '';
                            
                            weatherDay.innerHTML = `
                                <strong>${dayName} (${dateStr})</strong><br>
                                å¤©æ°”: ${weather}<br>
                                æ¸©åº¦: ${tempMin} ~ ${tempMax}<br>
                                å»ºè®®: ${suggestion}
                                ${aiSuggestion ? `<br><span style="color: #667eea;">AIå»ºè®®: ${aiSuggestion}</span>` : ''}
                            `;
                            weatherContainer.appendChild(weatherDay);
                        });
                    }
                    
                    // å¡«å……æ™¯ç‚¹ä¿¡æ¯ - æ”¯æŒAIå¢å¼ºæè¿°
                    const attractionsContainer = document.getElementById('attractions-list');
                    attractionsContainer.innerHTML = '';
                    if (data.sections.attractions) {
                        data.sections.attractions.forEach(attraction => {
                            const attractionItem = document.createElement('div');
                            attractionItem.className = 'attraction-item';
                            
                            let descriptionHTML = '';
                            if (attraction.ai_description) {
                                descriptionHTML = `æè¿°: ${attraction.ai_description}<br>
                                <small style="color: #667eea;">${attraction.description_source || 'AIå¢å¼ºæè¿°'}</small>`;
                            } else {
                                descriptionHTML = `æè¿°: ${attraction.description}`;
                            }
                            
                            attractionItem.innerHTML = `
                                <strong>${attraction.name}</strong>${attraction.enhanced_by_ai ? ' <small style="color: #667eea;">(AIå¢å¼º)</small>' : ''}<br>
                                è¯„åˆ†: ${attraction.rating}<br>
                                ${descriptionHTML}
                            `;
                            attractionsContainer.appendChild(attractionItem);
                        });
                    }
                    
                    // å¡«å……è¡Œç¨‹å®‰æ’ - æ”¯æŒAIä¼˜åŒ–è·¯çº¿
                    const routesContainer = document.getElementById('daily-routes');
                    routesContainer.innerHTML = '';
                    if (data.sections.routes) {
                        if (data.sections.routes.optimized_by_ai) {
                            // æ˜¾ç¤ºAIä¼˜åŒ–è·¯çº¿
                            const aiRouteContainer = document.createElement('div');
                            aiRouteContainer.className = 'route-day';
                            aiRouteContainer.innerHTML = `
                                <div style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                    <strong>AIä¼˜åŒ–è·¯çº¿</strong> <small style="color: #667eea;">${data.sections.routes.source}</small>
                                </div>
                                <div style="white-space: pre-line;">${data.sections.routes.optimized_routes}</div>
                            `;
                            routesContainer.appendChild(aiRouteContainer);
                            
                            // å¦‚æœæœ‰åŸå§‹è·¯çº¿ï¼Œæ·»åŠ åˆ‡æ¢æŒ‰é’®
                            if (data.sections.original_routes) {
                                const toggleBtn = document.createElement('button');
                                toggleBtn.textContent = 'æŸ¥çœ‹åŸå§‹è·¯çº¿';
                                toggleBtn.onclick = function() {
                                    const originalRoutesDiv = document.getElementById('original-routes');
                                    if (originalRoutesDiv.style.display === 'none' || !originalRoutesDiv.style.display) {
                                        originalRoutesDiv.style.display = 'block';
                                        this.textContent = 'éšè—åŸå§‹è·¯çº¿';
                                    } else {
                                        originalRoutesDiv.style.display = 'none';
                                        this.textContent = 'æŸ¥çœ‹åŸå§‹è·¯çº¿';
                                    }
                                };
                                routesContainer.appendChild(toggleBtn);
                                
                                const originalRoutesDiv = document.createElement('div');
                                originalRoutesDiv.id = 'original-routes';
                                originalRoutesDiv.style.display = 'none';
                                originalRoutesDiv.style.marginTop = '15px';
                                
                                data.sections.original_routes.forEach(route => {
                                    const routeDay = document.createElement('div');
                                    routeDay.className = 'route-day';
                                    routeDay.innerHTML = `<strong>${route.title}</strong>`;
                                    
                                    const spotsList = document.createElement('div');
                                    spotsList.className = 'route-spot';
                                    
                                    route.attractions.forEach(spot => {
                                        const spotItem = document.createElement('div');
                                        spotItem.innerHTML = `<strong>${spot.time}</strong> - ${spot.name}`;
                                        spotsList.appendChild(spotItem);
                                    });
                                    
                                    routeDay.appendChild(spotsList);
                                    originalRoutesDiv.appendChild(routeDay);
                                });
                                
                                routesContainer.appendChild(originalRoutesDiv);
                            }
                        } else {
                            // æ˜¾ç¤ºå¸¸è§„è·¯çº¿
                            data.sections.routes.forEach(route => {
                                const routeDay = document.createElement('div');
                                routeDay.className = 'route-day';
                                routeDay.innerHTML = `<strong>${route.title}</strong>`;
                                
                                const spotsList = document.createElement('div');
                                spotsList.className = 'route-spot';
                                
                                route.attractions.forEach(spot => {
                                    const spotItem = document.createElement('div');
                                    spotItem.innerHTML = `<strong>${spot.time}</strong> - ${spot.name}`;
                                    spotsList.appendChild(spotItem);
                                });
                                
                                routeDay.appendChild(spotsList);
                                routesContainer.appendChild(routeDay);
                            });
                        }
                    }
                    
                    // æ˜¾ç¤ºAIç»¼åˆå»ºè®®
                    if (data.sections.ai_comprehensive_suggestions) {
                        const aiSuggestionsContainer = document.createElement('div');
                        aiSuggestionsContainer.className = 'section';
                        aiSuggestionsContainer.innerHTML = `
                            <div class="section-title">ğŸ¤– AIæ™ºèƒ½æ—…è¡Œå»ºè®®</div>
                            <div style="background: #f0f8e8; padding: 15px; border-radius: 5px;">
                                <div style="white-space: pre-line;">${data.sections.ai_comprehensive_suggestions.content}</div>
                                <small style="color: #667eea;">${data.sections.ai_comprehensive_suggestions.source}</small>
                            </div>
                        `;
                        
                        // æ’å…¥åˆ°æ—…è¡Œå»ºè®®ä¹‹å‰
                        const suggestionsSection = document.querySelector('.section:has(#travel-suggestions)');
                        suggestionsSection.parentNode.insertBefore(aiSuggestionsContainer, suggestionsSection);
                    }
                    
                    // å¡«å……æ—…è¡Œå»ºè®®
                    const suggestionsContainer = document.getElementById('travel-suggestions');
                    suggestionsContainer.innerHTML = '';
                    if (data.sections.suggestions) {
                        data.sections.suggestions.forEach(suggestion => {
                            const suggestionItem = document.createElement('div');
                            suggestionItem.className = 'suggestion-item';
                            suggestionItem.innerHTML = `<strong>${suggestion.type}</strong>: ${suggestion.content}`;
                            suggestionsContainer.appendChild(suggestionItem);
                        });
                    }
                } else {
                    // æ˜¾ç¤ºé”™è¯¯
                    document.getElementById('plan-result').style.display = 'block';
                    document.getElementById('plan-result').innerHTML = `
                        <div class="error">
                            <strong>é”™è¯¯ï¼š</strong>${data.message || 'ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                clearTimeout(timeoutId); // ç¡®ä¿æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                clearInterval(progressInterval); // æ¸…é™¤è¿›åº¦æ›´æ–°è®¡æ—¶å™¨
                document.getElementById('loading').style.display = 'none';
                document.getElementById('plan-result').style.display = 'block';
                
                console.error('è¯·æ±‚é”™è¯¯:', error);
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'ç”Ÿæˆæ—…è¡Œè®¡åˆ’æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                let errorDetails = '';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶';
                    errorDetails = 'æ—…è¡Œè®¡åˆ’ç”Ÿæˆéœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œç³»ç»Ÿå·²å°†è¶…æ—¶æ—¶é—´å»¶é•¿è‡³60ç§’ã€‚è¯·ç¨åé‡è¯•ï¼Œæˆ–å°è¯•é€‰æ‹©è¾ƒçŸ­çš„æ—…è¡Œå¤©æ•°ï¼ˆ1-3å¤©ï¼‰ä»¥åŠ å¿«ç”Ÿæˆé€Ÿåº¦ã€‚'
                } else if (error.message && error.message.includes('ERR_CONNECTION_RESET')) {
                    errorMessage = 'æœåŠ¡å™¨è¿æ¥é‡ç½®';
                    errorDetails = 'æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•';
                } else if (error.message && error.message.includes('NetworkError')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥é—®é¢˜';
                    errorDetails = 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•';
                } else if (error.message) {
                    // æ˜¾ç¤ºAPIé”™è¯¯ä¿¡æ¯ï¼Œä½†é¿å…æš´éœ²è¿‡å¤šæŠ€æœ¯ç»†èŠ‚
                    errorMessage = error.message.replace(/APIé”™è¯¯:\s*\d+/i, 'æœåŠ¡å™¨é”™è¯¯');
                }
                
                // æ„å»ºé”™è¯¯æç¤ºHTML
                const errorHtml = `
                    <div class="error" style="padding: 15px; background: #ffebee; border-radius: 5px; color: #c62828;">
                        <strong>é”™è¯¯ï¼š</strong>${errorMessage}<br>
                        ${errorDetails ? `<small>${errorDetails}</small>` : ''}
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            <strong>æç¤ºï¼š</strong>è¯·ç¡®ä¿è¾“å…¥äº†æœ‰æ•ˆçš„åŸå¸‚åç§°å’Œæ—¥æœŸï¼Œæ—…è¡Œå¤©æ•°å»ºè®®æ§åˆ¶åœ¨1-3å¤©å†…ä»¥è·å¾—æ›´å¥½çš„ä½“éªŒã€‚
                        </div>
                    </div>
                `;
                
                document.getElementById('plan-result').innerHTML = errorHtml;
            });
        });

        // æŸ¥è¯¢æ™¯ç‚¹
        document.getElementById('attractions-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const city = document.getElementById('attraction-city').value;
            const limit = document.getElementById('attraction-limit').value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('attractions-result').style.display = 'none';
            
            // å‘é€è¯·æ±‚
            fetch(`/api/attractions?city=${encodeURIComponent(city)}&limit=${limit}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.status === 'success') {
                    // æ˜¾ç¤ºç»“æœ
                    document.getElementById('attractions-result').style.display = 'block';
                    document.getElementById('attractions-title').textContent = `${city}çš„çƒ­é—¨æ™¯ç‚¹`;
                    
                    // å¡«å……æ™¯ç‚¹ç½‘æ ¼
                    const grid = document.getElementById('attractions-grid');
                    grid.innerHTML = '';
                    
                    data.attractions.forEach(attraction => {
                        const card = document.createElement('div');
                        card.className = 'attraction-card';
                        card.innerHTML = `
                            <div class="attraction-name">${attraction.name}</div>
                            <div class="attraction-rating">â­ ${attraction.rating}</div>
                            <div>${attraction.description}</div>
                        `;
                        grid.appendChild(card);
                    });
                } else {
                    document.getElementById('attractions-result').style.display = 'block';
                    document.getElementById('attractions-result').innerHTML = `
                        <div class="error">
                            <strong>é”™è¯¯ï¼š</strong>${data.message || 'æŸ¥è¯¢æ™¯ç‚¹å¤±è´¥'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('attractions-result').style.display = 'block';
                document.getElementById('attractions-result').innerHTML = `
                    <div class="error">
                        <strong>é”™è¯¯ï¼š</strong>ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•
                    </div>
                `;
            });
        });

        // æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹ - ä½¿ç”¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const query = document.getElementById('chat-query').value;
            if (!query.trim()) return;
            
            const chatContainer = document.getElementById('chat-container');
            const userQuery = query.trim();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¸¦æ ·å¼ï¼‰
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = `
                <div class="message-avatar">ğŸ‘¤</div>
                <div class="message-content">${userQuery}</div>
            `;
            chatContainer.appendChild(userMessage);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('chat-query').value = '';
            
            // æ·»åŠ AIæ€è€ƒä¸­çŠ¶æ€
            const typingMessage = document.createElement('div');
            typingMessage.className = 'chat-message ai typing';
            typingMessage.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingMessage);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // è·å–å½“å‰é¡µé¢ä¸Šä¸‹æ–‡ï¼ˆå¦‚åŸå¸‚ã€å¤©æ•°ç­‰ï¼‰
            const context = {};
            if (document.getElementById('city')) {
                context.city = document.getElementById('city').value;
            }
            if (document.getElementById('days')) {
                context.days = document.getElementById('days').value;
            }
            if (document.getElementById('start-date')) {
                context.start_date = document.getElementById('start-date').value;
            }
            
            // å‘é€è¯·æ±‚åˆ°æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹APIï¼ˆå¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼‰
            fetch('/api/travel-assistant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    query: userQuery, 
                    context: context,
                    use_multi_agent: true
                })
            })
            .then(response => response.json())
            .then(data => {
                // ç§»é™¤æ€è€ƒä¸­çŠ¶æ€
                chatContainer.removeChild(typingMessage);
                
                // æ·»åŠ AIå›å¤ï¼ˆå¸¦æ ·å¼ï¼‰
                const agentMessage = document.createElement('div');
                agentMessage.className = 'chat-message ai';
                
                // ç¡®å®šä½¿ç”¨å“ªä¸ªæ™ºèƒ½ä½“çš„å›å¤
                let responseContent = data.content || 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ç”Ÿæˆå›å¤ã€‚';
                let agentName = 'æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹';
                let agentIcon = 'ğŸ¤–';
                
                // æ ¹æ®ä¸åŒçš„å›å¤æ¥æºæ˜¾ç¤ºä¸åŒçš„æ ‡è¯†
                if (data.agent_source === 'tourism_agent') {
                    agentName = 'æ—…æ¸¸é¡¾é—®';
                    agentIcon = 'ğŸ§³';
                } else if (data.agent_source === 'travel_planner_agent') {
                    agentName = 'æ—…è¡Œè§„åˆ’å¸ˆ';
                    agentIcon = 'ğŸ—“ï¸';
                }
                
                // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
                const formattedContent = responseContent.replace(/\n/g, '<br>');
                
                agentMessage.innerHTML = `
                    <div class="message-avatar">${agentIcon}</div>
                    <div class="message-content">
                        <div class="agent-name">${agentName}</div>
                        <div class="response-text">${formattedContent}</div>
                        ${data.generated_by_ai ? '<div class="ai-tag">AIç”Ÿæˆ</div>' : ''}
                    </div>
                `;
                
                chatContainer.appendChild(agentMessage);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            })
            .catch(error => {
                // ç§»é™¤æ€è€ƒä¸­çŠ¶æ€
                chatContainer.removeChild(typingMessage);
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message ai error';
                errorMessage.innerHTML = `
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div class="agent-name">æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹</div>
                        <div class="response-text">æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</div>
                    </div>
                `;
                chatContainer.appendChild(errorMessage);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        });
    </script>
</body>
</html>